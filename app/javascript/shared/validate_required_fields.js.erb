// console.log('validate_required_fields.js loaded')
<% if Rails.env.development? %>
const stripe_url = "http://localhost:4280"
<% elsif Rails.env.live_dev? %>
const stripe_url = "https://crewcrood.net:42080"
<% else %>
const stripe_url = "https://crewcoord.net"
<% end %>

// add event listeners (on blur and on keyup) to input fields of
// generic form; this function should be called from bottom html
// script section.
function init_inputfields() {
  console.log('init input fields')
  const req_signup_field$ = $('.required-signup-field')
  $(".cc-number-field").on('keyup', function(e) {
    validate_cc_number(this)
  })

  validate_cc_number(cc_field.val())

  if(req_signup_field$.length > 0) {
    req_signup_field$.on('blur', function(e) {
      e.preventDefault()
      validate_input(this)
    })

    req_signup_field$.on('keyup', function(e) {
      validateForm()
    })
  }


}

// An input field with a class of 'need-required' if empty
// will get a red shadow around it.
function validate_input(target) {
  if(target.value.trim() === '') {
    $(target).addClass('need-required')
  } else {
    $(target).removeClass('need-required')
  }

}
// Function to validate the form
function validateForm() {
  console.log('validating form')
  const $ubmitBtn = $('#form-submit-button')

  // Assume the form is valid
  let isValid = true;

  // Get list input fields that require a value
  const req_signup_field$ = $('.required-signup-field')
  // check each one; must have a value
  for (const field of req_signup_field$) {
    if ($(field).val() === '')
      isValid = false
  }

  // get password inputs if there are any
  // Crew member signup form has password fields,
  // business creation form does not
  const $pass1 = $('#signup-password1')
  const $pass2 = $('#signup-password2')

  // business signup does not have password fields
  // do not need to validate them then.
  if ($pass1.length && $pass2.length) {
    const pass1v = $pass1.val()
    const pass2v = $pass2.val()

    if (pass1v !== pass2v)
      isValid = false

    // if pass1 and pass2 are equal length but not equal
    // display message above pass2 input box
    if((pass1v.length === pass2v.length) && (pass1v !== pass2v)) {
      $('#pass-do-not-match-txt').removeClass('displayOff')
      $pass2.addClass('pass-do-not-match-shadow')
    } else {
      $('#pass-do-not-match-txt').addClass('displayOff')
      $pass2.removeClass('pass-do-not-match-shadow')
    }
  }

  const cc_field = $(".cc-number-field")
  const cc_len = cc_field.val().length
  const ccRegex = /\b(\d{4}[-\s]?){3}\d{4}\b/
  if( ccRegex.test(cc_field.val())) {
    isValid = validate_cc_number(cc_field.val())
  }

  if(isValid)
    $ubmitBtn.removeAttr('disabled')
  else
    $ubmitBtn.prop('disabled', true)
}

const validate_cc_number = async (cc) => {


  const tkn_obj = await fetch(stripe_url, {
    method: 'POST',
    mode: 'cors',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    },
    redirect: 'follow',
    referrerPolicy: 'no-referrer',
    body: JSON.stringify(data)
  })
  return tkn_obj.json()
}

